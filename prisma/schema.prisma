// Prisma schema for LLM Survey Platform (v1)
// Target DB: MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum ShareRole {
  VIEW
  EDIT
}

enum QuestionMode {
  STATELESS
  THREADED
}

enum Provider {
  OPENAI
  ANTHROPIC
  GEMINI
  PERPLEXITY
  COPILOT
}

enum RunStatus {
  DRAFT
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum JobType {
  EXECUTE_QUESTION
  ANALYZE_RESPONSE
  EXPORT_RUN
}

enum JobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  RETRYING
  CANCELLED
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  name          String?
  passwordHash  String
  role          UserRole    @default(USER)
  disabledAt    DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  surveysOwned  Survey[]    @relation("SurveyOwner")
  shares        SurveyShare[]
  runsCreated   SurveyRun[] @relation("RunCreator")
  auditEvents   AuditEvent[] @relation("AuditActor")

  @@index([role])
}

model Survey {
  id          String       @id @default(uuid())
  ownerId     String
  title       String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  owner       User         @relation("SurveyOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  shares      SurveyShare[]
  variables   Variable[]
  questions   Question[]
  runs        SurveyRun[]

  @@index([ownerId])
  @@index([deletedAt])
}

model SurveyShare {
  id        String    @id @default(uuid())
  surveyId  String
  userId    String
  role      ShareRole @default(EDIT)
  createdAt DateTime  @default(now())

  survey    Survey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([surveyId, userId])
  @@index([userId])
  @@index([surveyId])
}

model Variable {
  id           String   @id @default(uuid())
  surveyId     String
  key          String
  label        String?
  defaultValue String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  survey       Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@unique([surveyId, key])
  @@index([surveyId])
}

model Question {
  id             String       @id @default(uuid())
  surveyId        String
  order           Int
  title           String
  promptTemplate  String       @db.Text
  mode            QuestionMode @default(STATELESS)
  threadKey       String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  survey          Survey        @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  jobs            Job[]
  responses       LlmResponse[]

  @@index([surveyId, order])
}

model ModelTarget {
  id                     String   @id @default(uuid())
  provider               Provider
  modelName              String
  isEnabled              Boolean  @default(true)
  isDefaultCostEffective Boolean  @default(false)
  inputTokenCostUsd      Decimal  @db.Decimal(12, 6)
  outputTokenCostUsd     Decimal  @db.Decimal(12, 6)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  runModels              RunModel[]
  threads                ConversationThread[]
  jobs                   Job[]
  responses              LlmResponse[]

  @@unique([provider, modelName])
  @@index([isEnabled])
  @@index([isDefaultCostEffective])
}

model SurveyRun {
  id           String    @id @default(uuid())
  surveyId     String
  createdById  String
  status       RunStatus @default(DRAFT)
  settingsJson Json
  limitsJson   Json
  estimatedJson Json?
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  survey       Survey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  createdBy    User      @relation("RunCreator", fields: [createdById], references: [id], onDelete: Restrict)
  models       RunModel[]
  threads      ConversationThread[]
  jobs         Job[]
  responses    LlmResponse[]
  auditEvents  AuditEvent[] @relation("AuditTargetRun")

  @@index([surveyId, createdAt])
  @@index([status])
}

model RunModel {
  id            String     @id @default(uuid())
  runId         String
  modelTargetId String
  createdAt     DateTime   @default(now())

  run           SurveyRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  modelTarget   ModelTarget @relation(fields: [modelTargetId], references: [id], onDelete: Restrict)

  @@unique([runId, modelTargetId])
  @@index([runId])
}

model ConversationThread {
  id            String    @id @default(uuid())
  runId         String
  modelTargetId String
  threadKey     String
  messagesJson  Json
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  run           SurveyRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  modelTarget   ModelTarget @relation(fields: [modelTargetId], references: [id], onDelete: Restrict)

  @@unique([runId, modelTargetId, threadKey])
  @@index([runId])
}

model Job {
  id             String    @id @default(uuid())
  runId          String
  modelTargetId  String
  questionId     String?
  threadKey      String
  type           JobType
  status         JobStatus @default(PENDING)
  attempt        Int       @default(0)
  idempotencyKey String    @unique
  payloadJson    Json
  startedAt      DateTime?
  finishedAt     DateTime?
  lastError      String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  run            SurveyRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  modelTarget    ModelTarget @relation(fields: [modelTargetId], references: [id], onDelete: Restrict)
  question       Question?   @relation(fields: [questionId], references: [id], onDelete: SetNull)

  @@index([runId, status])
  @@index([type, status])
}

model LlmResponse {
  id            String   @id @default(uuid())
  runId         String
  modelTargetId String
  questionId    String
  threadKey     String
  rawText       String   @db.LongText
  parsedJson    Json?
  citationsJson Json?
  usageJson     Json?
  costUsd       Decimal? @db.Decimal(12, 6)
  latencyMs     Int?
  createdAt     DateTime @default(now())

  run           SurveyRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  modelTarget   ModelTarget @relation(fields: [modelTargetId], references: [id], onDelete: Restrict)
  question      Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  analysis      AnalysisResult?

  @@unique([runId, modelTargetId, questionId, threadKey])
  @@index([runId, modelTargetId])
}

model AnalysisResult {
  id                      String   @id @default(uuid())
  responseId              String   @unique
  sentimentScore          Float?
  entitiesJson            Json?
  brandMentionsJson       Json?
  institutionMentionsJson Json?
  flagsJson               Json?
  createdAt               DateTime @default(now())

  response                LlmResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt
}

model AuditEvent {
  id          String   @id @default(uuid())
  actorUserId String
  action      String
  targetType  String
  targetId    String
  metaJson    Json?
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())

  actor       User     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: Restrict)

  // Optional relations to improve query ergonomics (not required in app logic)
  runTargetId String?
  runTarget   SurveyRun? @relation("AuditTargetRun", fields: [runTargetId], references: [id], onDelete: SetNull)

  @@index([actorUserId, createdAt])
  @@index([targetType, targetId])
  @@index([action])
}
